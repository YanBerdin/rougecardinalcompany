# Revue Plan TASK030 - Display Toggles

**Date**: 1er janvier 2026  
**Statut**: ‚úÖ Plan valid√© et mis √† jour  
**Branche**: `feat-display-toggles`

---

## üìã Objectif de la Revue

V√©rifier la coh√©rence du plan TASK030 avec :

- Les audits de s√©curit√© RLS/SECURITY INVOKER (31 d√©cembre 2025)
- Les patterns √©tablis dans le projet (CRUD Server Actions, DAL SOLID)
- L'√©tat actuel du sch√©ma database (`10_tables_system.sql`)

---

## ‚úÖ R√©sultats de l'Analyse

### Points Valid√©s (Aucune Modification Requise)

1. **S√©curit√© RLS** ‚úÖ
   - Policies existantes dans `10_tables_system.sql` sont **d√©j√† correctes**
   - Pattern `key like 'public:%'` pour lecture publique √©tabli
   - Admin access avec `(select public.is_admin())` conforme

2. **Pattern CRUD Server Actions** ‚úÖ
   - DAL retourne `DALResult<T>` correctement
   - `revalidatePath()` uniquement dans Server Actions (pas DAL)
   - Validation Zod √† tous les niveaux

3. **Architecture Smart/Dumb** ‚úÖ
   - Container (Server) / View (Client) s√©paration respect√©e
   - `useEffect` pour sync props ‚Üí state (pattern post-migration Nov 2025)
   - Types Props colocalis√©s dans `types.ts`

4. **Structure Migration** ‚úÖ
   - Migration idempotente avec checks `if not exists`
   - Seed data avec structure JSON unifi√©e `{"enabled": true, "max_items": N}`
   - Breaking change document√© : `public:presse:media_kit_enabled` ‚Üí `public:presse:media_kit`

---

## üîß Modifications Apport√©es (3 Ajustements Mineurs)

### 1. Ajout R√©f√©rence SECURITY INVOKER

**Fichier**: `plan-TASK030:-Display Toggles.prompt.md`  
**Section**: "Architecture Base de Donn√©es"

**Ajout√©**:

> **Note S√©curit√©** : Toutes les vues cr√©√©es pour ce syst√®me doivent utiliser
> `WITH (security_invoker = true)` conform√©ment au guide
> `.github/prompts/plan-fixRlsBaseTablesAdminViewsSecurity/database-view-security-guide.md`
> (d√©cembre 2025).

**Justification**:

- Audit SECURITY INVOKER du 31 d√©cembre 2025 a √©tabli ce standard
- 11 vues d√©j√† s√©curis√©es selon ce pattern
- Pr√©vention des erreurs futures (SECURITY DEFINER non autoris√©)

---

### 2. Clarification Colonnes Existantes (Migration STEP 1)

**Fichier**: `plan-TASK030:-Display Toggles.prompt.md`  
**Section**: "Migration Seed - STEP 1"

**Avant**:

```sql
-- STEP 1: Add metadata columns (idempotent)
```

**Apr√®s**:

```sql
-- STEP 1: Verify metadata columns (already present in 10_tables_system.sql)
-- ‚úÖ NOTE: Les colonnes description, category, updated_by existent d√©j√† dans le sch√©ma
-- ‚úÖ NOTE: Cette section est conserv√©e pour compatibilit√© avec anciennes versions
```

**Justification**:

- √âviter confusion : colonnes `description`, `category`, `updated_by` **existent d√©j√†**
- Migration sera NO-OP sur database actuelle (checks `if not exists` passeront)
- Clarification pour futurs d√©veloppeurs

---

### 3. Ajout Section S√©curit√© et Conformit√©

**Fichier**: `plan-TASK030:-Display Toggles.prompt.md`  
**Section**: Nouvelle section avant "R√©f√©rences"

**Ajout√©**:

```markdown
## üîí S√©curit√© et Conformit√©

### Checklist S√©curit√© (Bas√©e sur Audits D√©cembre 2025)

- [ ] **RLS Policies** : Conformes au pattern √©tabli dans `10_tables_system.sql`
  - ‚úÖ Public read : `key like 'public:%'` OR `(select public.is_admin())`
  - ‚úÖ Admin full access : `(select public.is_admin())` pour INSERT/UPDATE/DELETE
- [ ] **SECURITY INVOKER** : Si vues cr√©√©es, utiliser `WITH (security_invoker = true)`
- [ ] **DAL Pattern** : `DALResult<T>`, pas de `revalidatePath()` dans DAL
- [ ] **Server Actions** : `requireAdmin()` explicite + `revalidatePath()` dans actions uniquement
- [ ] **TypeScript** : Pas de `any`, types stricts, validation Zod
- [ ] **Tests S√©curit√©** : Script pour tester acc√®s anon vs admin

### R√©f√©rences Audits

- Audit RLS complet : 31 d√©cembre 2025 (36/36 tables prot√©g√©es)
- SECURITY INVOKER enforcement : 31 d√©cembre 2025 (11 vues s√©curis√©es)
- Tests pass√©s : 13/13 ‚úÖ (`scripts/check-views-security.ts`)
```

**Justification**:

- Checklist actionable pour validation pr√©-merge
- Tra√ßabilit√© vers audits de s√©curit√© r√©cents
- R√©f√©rence script de test existant

---

## üìä Conformit√© Globale

| Aspect | Statut | Notes |
| -------- | -------- | ------- |
| **RLS Policies** | ‚úÖ Conforme | Policies existantes correctes |
| **SECURITY INVOKER** | ‚úÖ Document√© | R√©f√©rence guide ajout√©e |
| **Pattern CRUD** | ‚úÖ Conforme | DALResult + Server Actions |
| **Smart/Dumb** | ‚úÖ Conforme | Container/View s√©paration |
| **TypeScript** | ‚úÖ Conforme | Dual schema Server/UI |
| **Migration** | ‚úÖ Conforme | Idempotente + seed |
| **Tests** | ‚ö†Ô∏è √Ä impl√©menter | Script test √† cr√©er |

---

## üéØ Prochaines √âtapes

### Phase 1: Backend (2h) - READY TO START ‚úÖ

Aucun obstacle technique. Plan valid√© pour impl√©mentation.

**Ordre d'ex√©cution recommand√©**:

1. Cr√©er migration `[timestamp]_migrate_display_toggles.sql`
2. Tester localement : `pnpm dlx supabase db reset`
3. Cr√©er schemas Zod `lib/schemas/site-config.ts`
4. Impl√©menter DAL `lib/dal/site-config.ts`
5. Cr√©er Server Actions `lib/actions/site-config-actions.ts`
6. Script test : `scripts/test-display-toggles.ts`

### Phase 2-5: Selon Plan Original

Le reste du plan (UI Admin, Frontend Gating, Dashboard Stats, Tests) reste inchang√©.

---

## üìö R√©f√©rences Documentation

### Guides S√©curit√© (D√©cembre 2025)

- `.github/prompts/plan-fixRlsBaseTablesAdminViewsSecurity/database-view-security-guide.md`
- `.github/prompts/plan-fixRlsBaseTablesAdminViewsSecurity/plan-fixRlsBaseTablesAdminViews.prompt.md`

### Patterns √âtablis

- `.github/instructions/crud-server-actions-pattern.instructions.md`
- `.github/instructions/dal-solid-principles.instructions.md`
- `.github/instructions/nextjs-supabase-auth-2025.instructions.md`

### Memory Bank

- `memory-bank/activeContext.md` ‚Äî Updates 31 d√©cembre 2025 (RLS fixes)
- `memory-bank/progress.md` ‚Äî Database Security completed

---

## ‚úÖ Conclusion

**Statut Final**: Le plan TASK030 est **VALID√â** pour impl√©mentation.

**Changements Requis**: Mineurs (3 ajustements documentation uniquement)  
**Blockers**: Aucun  
**Risques**: Faibles (patterns √©prouv√©s depuis novembre 2025)

**Ready to Start**: ‚úÖ Oui  
**Estimated Timeline**: 4-6 heures (inchang√©)  
**Priority**: Moyenne

---

**Review√© par**: GitHub Copilot  
**Date**: 1er janvier 2026  
**Commit**: √Ä cr√©er apr√®s validation utilisateur
