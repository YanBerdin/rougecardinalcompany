name: Weekly Database Backup

# TASK050: Automated database backup strategy
# 
# SCHEDULE:
#   - Every Sunday at 3:00 AM UTC
#   - Manual trigger via workflow_dispatch
# 
# STORAGE:
#   - Uploads to Supabase Storage bucket 'backups'
#   - Retention: 4 weeks (automated rotation in script)
# 
# NOTIFICATIONS:
#   - GitHub sends email on workflow failure (default)
#   - Check Actions tab for execution history
# 
# REQUIRED SECRETS:
#   - SUPABASE_DB_URL: PostgreSQL connection string
#   - SUPABASE_SECRET_KEY: Service role key for Storage upload
#   - NEXT_PUBLIC_SUPABASE_URL: Supabase project URL

on:
  schedule:
    # Every Sunday at 3:00 AM UTC (cron: minute hour day month weekday)
    - cron: '0 3 * * 0'
  
  workflow_dispatch:
    # Allow manual trigger from GitHub Actions UI

jobs:
  backup:
    name: Create Database Backup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
        contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Install PostgreSQL client tools
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client-16
          pg_dump --version
      
      - name: Execute backup script
        run: pnpm exec tsx scripts/backup-database.ts
        env:
          # Backup-specific environment variables
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          SUPABASE_SECRET_KEY: ${{ secrets.SUPABASE_SECRET_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          
          # Required dummy values for T3 Env validation
          NEXT_PUBLIC_SITE_URL: "https://rougecardinal.example"
          RESEND_API_KEY: "re_dummy_backup_workflow"
          EMAIL_FROM: "backup@example.com"
          EMAIL_CONTACT: "contact@example.com"
          
          # Skip T3 Env validation - we only need backup-related vars
          SKIP_ENV_VALIDATION: "1"
      
      - name: Report success
        if: success()
        run: |
          echo "‚úÖ Backup completed successfully at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "üì¶ Backup uploaded to Supabase Storage bucket 'backups'"
          echo "üîÑ Old backups rotated (keeping last 4)"
      
      - name: Report failure
        if: failure()
        run: |
          echo "‚ùå Backup failed at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "üìß GitHub will send email notification to repository admins"
          echo "üîç Check workflow logs for error details"
          exit 1
