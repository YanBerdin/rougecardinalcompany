name: Detect REVOKE in migrations (warn-only)

on:
  push:
    branches: [ feature/backoffice, main ]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  detect-revoke:
    name: Scan changed migrations for REVOKE (warn-only)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed files
        id: changed
        run: |
          echo "Determining changed files..."
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE=${{ github.event.pull_request.base.ref }}
            echo "Fetching base branch $BASE"
            git fetch origin $BASE --depth=1 || true
            CHANGED=$(git diff --name-only origin/$BASE...HEAD || true)
          else
            # For pushes, compare against previous commit
            CHANGED=$(git diff --name-only HEAD~1 HEAD || true)
          fi
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Scan changed migration SQLs for REVOKE
        run: |
          set -eu
          CHANGED="${{ steps.changed.outputs.changed_files }}"
          echo "Changed files:"; echo "$CHANGED"
          FOUND=0
          # Iterate over changed files and scan only SQL migration files under supabase/migrations
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            case "$file" in
              supabase/migrations/*.sql|supabase/migrations/**/*.sql)
                if grep -n -E '\bREVOKE\b' -- "$file" >/dev/null 2>&1; then
                  FOUND=1
                  # Print a workflow annotation (warning) for the first match
                  echo "::warning file=$file::REVOKE found in migration $file - please confirm intent and add to allowlist if intentional."
                  # show matching lines for context
                  echo "--- matches in $file ---"
                  grep -n -E '\bREVOKE\b' -- "$file" | sed -n '1,200p' || true
                fi
                ;;
              *)
                ;;
            esac
          done <<< "$CHANGED"

          if [ "$FOUND" -eq 1 ]; then
            echo "Warning: one or more changed migration files contain REVOKE statements. This job is warn-only and will not fail the run."
            echo "If these REVOKE statements are intentional, add an explanation to the PR and consider adding the affected objects to supabase/scripts/allowed_exposed_objects.txt if they are intentionally exposed."
          else
            echo "No REVOKE statements found in changed migration files."
          fi
