# Security Fixes - Next.js CVE Corrections

**Date:** 2026-01-30  
**Commit:** 050166e  
**Issue:** [#30](https://github.com/YanBerdin/rougecardinalcompany/issues/30)

---

## ðŸ“Š Summary

**Total:** 3 vulnerabilities fixed (1 HIGH, 2 MODERATE)  
**Package:** Next.js `16.0.10` â†’ `16.1.5`  
**Detection:** Dependabot + `pnpm audit`

---

## ðŸ”´ 1. HIGH - HTTP Deserialization DoS (CVE-2026-23864)

**Advisory:** [GHSA-h25m-26qc-wcjf](https://github.com/advisories/GHSA-h25m-26qc-wcjf)  
**CVSS Score:** 7.5 (AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H)  
**CWE:** CWE-400 (Uncontrolled Resource Consumption), CWE-502 (Deserialization)

### Description

A vulnerability in React Server Components deserialization allows attackers to send specially crafted HTTP requests to App Router Server Function endpoints that can cause:

- Excessive CPU usage
- Out-of-memory exceptions
- Server crashes (Denial of Service)

### Impact on rougecardinalcompany

- âœ… **Affected:** We use App Router (`app/` directory)
- âœ… **Affected:** We use Server Actions and Server Components
- ðŸ”´ **Risk Level:** HIGH (all server endpoints potentially vulnerable)

### Fix

Upgrade to Next.js `16.0.11` or later (we upgraded to `16.1.5`).

---

## ðŸŸ¡ 2. MODERATE - Image Optimizer DoS (CVE-2025-59471)

**Advisory:** [GHSA-9g9p-9gw9-jx7f](https://github.com/advisories/GHSA-9g9p-9gw9-jx7f)  
**CVSS Score:** 5.9 (AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H)  
**CWE:** CWE-400, CWE-770 (Allocation of Resources Without Limits)

### Description

The Image Optimizer endpoint (`/_next/image`) loads external images entirely into memory without enforcing a maximum size limit. Attackers can cause out-of-memory conditions by requesting optimization of arbitrarily large images.

### Pre-requisites for Exploitation

- `remotePatterns` configured for external domains in `next.config.ts`
- Attacker can serve or control a large image on an allowed domain

### Impact on rougecardinalcompany

- âœ… **NOT Affected:** We don't have `remotePatterns` configured in `next.config.ts`
- ðŸŸ¢ **Risk Level:** LOW (vulnerability not exploitable in our configuration)

### Fix

Upgrade to Next.js `16.1.5` or later.

---

## ðŸŸ¡ 3. MODERATE - PPR Resume Endpoint DoS (CVE-2025-59472)

**Advisory:** [GHSA-5f7q-jpqc-wp7h](https://github.com/advisories/GHSA-5f7q-jpqc-wp7h)  
**CVSS Score:** 5.9 (AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H)  
**CWE:** CWE-400, CWE-409 (Improper Handling of Decompression), CWE-770

### Description

Two closely related vulnerabilities in PPR (Partial Prerendering) mode:

1. **Unbounded request body buffering** using `Buffer.concat()` without size limit
2. **Unbounded decompression (zipbomb)** using `inflateSync()` without output size limit

A small compressed payload can expand to hundreds of MB/GB, causing memory exhaustion and Node.js process termination.

### Pre-requisites for Exploitation

- Partial Prerendering enabled (`experimental.ppr: true` in `next.config.ts`)
- Minimal mode enabled (`NEXT_PRIVATE_MINIMAL_MODE=1` environment variable)

### Impact on rougecardinalcompany

- âœ… **NOT Affected:** We don't use PPR (`experimental.ppr` not configured)
- âœ… **NOT Affected:** We don't use minimal mode (no `NEXT_PRIVATE_MINIMAL_MODE`)
- ðŸŸ¢ **Risk Level:** LOW (vulnerability not exploitable in our configuration)

### Fix

Upgrade to Next.js `16.1.5` or later.

---

## âœ… Resolution

### Changes Applied

**package.json:**

```diff
- "next": "16.0.10"
+ "next": "16.1.5"
```

**Dependencies updated:**

- `next@16.1.5` (was `16.0.10`)
- `@next/swc-linux-x64-gnu@16.1.5`
- `@next/swc-linux-x64-musl@16.1.5`
- All platform-specific SWC binaries

### Validation Tests

```bash
# 1. Security audit
âœ… pnpm audit
No known vulnerabilities found

# 2. Production build
âœ… pnpm build
â–² Next.js 16.1.5 (Turbopack)
âœ“ Compiled successfully in 14.5s
âœ“ Generating static pages (37/37) in 712.6ms
âœ“ Finalizing page optimization

# 3. TypeScript check
âœ… Running TypeScript...
No type errors found

# 4. Linting
âœ… pnpm lint
No ESLint errors
```

### Expected Build Warnings

The following warnings during build are **EXPECTED** and **CORRECT BEHAVIOR**:

```
Dynamic server usage: Route /admin/users couldn't be rendered statically because it used `cookies`
Dynamic server usage: Route /compagnie couldn't be rendered statically because it used `cookies`
Dynamic server usage: Route /spectacles couldn't be rendered statically because it used `cookies`
```

**Reason:** These routes use Supabase authentication cookies and are correctly configured with:

```typescript
export const dynamic = 'force-dynamic';
export const revalidate = 0;
```

This is per Next.js 16 requirements for pages using server-side authentication.

---

## ðŸ“š References

- [Next.js 16.1.5 Release Notes](https://github.com/vercel/next.js/releases/tag/v16.1.5)
- [Vercel CVE Summary](https://vercel.com/changelog/summaries-of-cve-2025-59471-and-cve-2025-59472)
- [React RSC CVE-2026-23864](https://github.com/facebook/react/security/advisories/GHSA-83fc-fqcc-2hmg)
- [Next.js Dynamic Server Error Docs](https://nextjs.org/docs/messages/dynamic-server-error)

---

## ðŸŽ¯ Future Recommendations

### Short-term (Optional)

Review and update other outdated dependencies:

- `react@19.2.4` (currently `19.2.0`) - +4 patch versions
- `@supabase/supabase-js@2.93.3` (currently `2.74.0`) - +19 minor versions
- `@sentry/nextjs@10.38.0` (currently `10.33.0`) - +5 minor versions

### Long-term

1. **Enable Dependabot alerts** in repository settings
2. **Setup automated dependency updates** (Renovate or Dependabot PRs)
3. **Add security audit to CI/CD pipeline**:

   ```yaml
   - name: Security Audit
     run: pnpm audit --audit-level=moderate
   ```

---

**Status:** âœ… RESOLVED  
**Deployed:** Pending staging validation  
**Assignee:** @YanBerdin
